"use client";

import React, { useState, useEffect } from "react";
import Link from "next/link";
import { useRouter } from "next/navigation";
import { useForm } from "@tanstack/react-form";
import { resetPasswordSchema, ResetPasswordInput } from "@/libs/schemas/auth.schema";
import { apiClient, handleApiError } from "@/libs/api/axios";
import { api } from "@/libs/api/endpoints";
import { FieldInfo } from "@/components/Form/FieldInfo";
import {
  InputOTP,
  InputOTPGroup,
  InputOTPSlot,
} from "@/components/ui/input-otp";
import { CheckCircleIcon, ArrowLeft } from "@phosphor-icons/react";
import PasswordStrengthIndicator from "@/components/common/PasswordStrengthIndicator";

type Stage = 1 | 2 | 3;

export default function ForgotPasswordForm() {
  const [submitError, setSubmitError] = useState<string | null>(null);
  const [successMessage, setSuccessMessage] = useState<string | null>(null);
  const [currentStage, setCurrentStage] = useState<Stage>(1);
  const [resendSuccess, setResendSuccess] = useState(false);
  const [resendLoading, setResendLoading] = useState(false);
  const [resendTimer, setResendTimer] = useState(0);
  const [isTransitioning, setIsTransitioning] = useState(false);
  const router = useRouter();

  // Timer countdown effect
  useEffect(() => {
    if (resendTimer > 0) {
      const interval = setInterval(() => {
        setResendTimer((prev) => prev - 1);
      }, 1000);
      return () => clearInterval(interval);
    } else {
      setResendSuccess(false);
    }
  }, [resendTimer]);

  const form = useForm({
    defaultValues: {
      email: "",
      code: "",
      newPassword: "",
      confirmPassword: "",
    } as ResetPasswordInput,
    onSubmit: async ({ value }) => {
      setSubmitError(null);
      setSuccessMessage(null);

      try {
        if (currentStage === 1) {
          // Stage 1: Request OTP - only validate email
          if (!value.email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value.email)) {
            setSubmitError("Please enter a valid email address");
            return;
          }

          await apiClient.post(api.auth.requestResetPasswordCode, {
            email: value.email,
          });
          
          // Show success message
          setSuccessMessage("Code sent successfully! Check your email.");
          setIsTransitioning(true);
          
          // Wait 2 seconds before transitioning to show success message
          setTimeout(() => {
            setCurrentStage(2);
            setResendTimer(60); // Start 60s timer
            setIsTransitioning(false);
            setSuccessMessage(null);
          }, 2000);
        } else if (currentStage === 2) {
          // Stage 2: Verify OTP - validate code format
          if (!value.code || !/^[0-9]{6}$/.test(value.code)) {
            setSubmitError("Please enter a valid 6-digit code");
            return;
          }
          
          // Move to Stage 3
          setCurrentStage(3);
        } else if (currentStage === 3) {
          // Stage 3: Reset password - validate all fields
          if (!value.code || !/^[0-9]{6}$/.test(value.code)) {
            setSubmitError("Please enter a valid 6-digit code");
            return;
          }
          
          if (!value.newPassword || value.newPassword.length < 8) {
            setSubmitError("Password must be at least 8 characters");
            return;
          }
          
          if (!/[A-Z]/.test(value.newPassword)) {
            setSubmitError("Password must contain at least one uppercase letter");
            return;
          }
          
          if (!/[a-z]/.test(value.newPassword)) {
            setSubmitError("Password must contain at least one lowercase letter");
            return;
          }
          
          if (!/[0-9]/.test(value.newPassword)) {
            setSubmitError("Password must contain at least one number");
            return;
          }
          
          if (value.newPassword !== value.confirmPassword) {
            setSubmitError("Passwords don't match");
            return;
          }
          
          // All validation passed - reset password
          await apiClient.post(api.auth.resetPasswordByCode, {
            email: value.email,
            code: parseInt(value.code),
            newPassword: value.newPassword,
          });

          // Success - redirect to login
          router.push("/login?reset=success");
        }
      } catch (error) {
        console.error("Forgot password error:", error);
        const errorMessage = handleApiError(error);

        // Handle "User does not exist" on stage 1 - still show success for security
        if (currentStage === 1 && errorMessage === "User does not exist") {
          setSuccessMessage("If an account exists with this email, you will receive a code shortly.");
          setIsTransitioning(true);
          
          setTimeout(() => {
            setCurrentStage(2);
            setResendTimer(60);
            setIsTransitioning(false);
            setSuccessMessage(null);
          }, 2000);
          return;
        }

        setSubmitError(errorMessage);
      }
    },
  });

  const handleResendOTP = async () => {
    setSubmitError(null);
    setResendLoading(true);
    setResendSuccess(false);

    try {
      const email = form.getFieldValue("email");
      await apiClient.post(api.auth.requestResetPasswordCode, {
        email: email,
      });

      setResendSuccess(true);
      setResendTimer(60); // 60 second countdown
    } catch (error) {
      const errorMessage = handleApiError(error);
      setSubmitError(errorMessage);
    } finally {
      setResendLoading(false);
    }
  };

  const handleBackToEmail = () => {
    setCurrentStage(1);
    setSubmitError(null);
    form.setFieldValue("code", "");
  };

  return (
    <div>
      {/* Stage 1: Email Input */}
      {currentStage === 1 && (
        <>
          <div className="heading4">Reset your password</div>
          <div className="body1 mt-2">
            We will send you an email to reset your password
          </div>
          <form
            onSubmit={(e) => {
              e.preventDefault();
              e.stopPropagation();
              form.handleSubmit();
            }}
            className="md:mt-7 mt-4">
            {/* Email */}
            <form.Field
              name="email"
              children={(field) => {
                const hasError =
                  field.state.meta.isTouched && !field.state.meta.isValid;

                return (
                  <div>
                    <input
                      className={`border-line px-4 pt-3 pb-3 w-full rounded-lg ${
                        hasError ? "border-red-600" : ""
                      }`}
                      id={field.name}
                      name={field.name}
                      type="email"
                      placeholder="Email address *"
                      autoComplete="email"
                      value={field.state.value}
                      onBlur={field.handleBlur}
                      onChange={(e) => field.handleChange(e.target.value)}
                    />
                    <FieldInfo field={field} />
                  </div>
                );
              }}
            />

            {/* Success Message */}
            {successMessage && (
              <div className="p-4 bg-green-100 border border-green-400 text-green-700 rounded-lg mt-5">
                <p className="text-sm">{successMessage}</p>
              </div>
            )}

            {/* Error Message */}
            {submitError && (
              <div className="p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg mt-5">
                <p className="text-sm">{submitError}</p>
              </div>
            )}

            {/* Submit Button */}
            <div className="block-button md:mt-7 mt-4">
              <form.Subscribe
                selector={(state) => [state.canSubmit, state.isSubmitting]}
                children={([canSubmit, isSubmitting]) => (
                  <button
                    type="submit"
                    disabled={!canSubmit || isSubmitting || isTransitioning}
                    className="button-main w-full disabled:opacity-50 disabled:cursor-not-allowed">
                    {isSubmitting ? "Sending..." : isTransitioning ? "Code Sent!" : "Submit"}
                  </button>
                )}
              />
            </div>

            <div className="mt-4 text-center text-sm text-secondary2">
              Remember your password?{" "}
              <Link href="/login" className="text-black hover:underline">
                Back to Login
              </Link>
            </div>
          </form>
        </>
      )}

      {/* Stage 2: OTP Verification */}
      {currentStage === 2 && (
        <>
          <button
            type="button"
            onClick={handleBackToEmail}
            className="flex items-center gap-2 text-secondary hover:text-black transition-colors mb-4">
            <ArrowLeft size={20} />
            <span>Change email</span>
          </button>

          <div className="heading4">Verify Code</div>
          <div className="body1 mt-2">
            We've sent a 6-digit code to{" "}
            <span className="font-semibold text-black">
              {form.getFieldValue("email")}
            </span>
          </div>

          <form
            onSubmit={(e) => {
              e.preventDefault();
              e.stopPropagation();
              form.handleSubmit();
            }}
            className="md:mt-7 mt-4">
            {/* OTP Input */}
            <form.Field
              name="code"
              children={(field) => {
                const hasError =
                  field.state.meta.isTouched && !field.state.meta.isValid;

                return (
                  <div className="flex flex-col items-center mb-6">
                    <InputOTP
                      maxLength={6}
                      value={field.state.value}
                      onChange={(value) => field.handleChange(value)}
                      onBlur={field.handleBlur}>
                      <InputOTPGroup className="gap-3">
                        <InputOTPSlot inputMode="numeric" index={0} />
                        <InputOTPSlot inputMode="numeric" index={1} />
                        <InputOTPSlot inputMode="numeric" index={2} />
                        <InputOTPSlot inputMode="numeric" index={3} />
                        <InputOTPSlot inputMode="numeric" index={4} />
                        <InputOTPSlot inputMode="numeric" index={5} />
                      </InputOTPGroup>
                    </InputOTP>
                    <div className="mt-3">
                      <FieldInfo field={field} />
                    </div>
                  </div>
                );
              }}
            />

            {/* Resend OTP */}
            <div className="text-center mb-6">
              {resendSuccess ? (
                <div className="flex flex-col items-center gap-1">
                  <div className="flex items-center gap-2 text-success text-sm">
                    <CheckCircleIcon size={16} weight="fill" />
                    <span className="font-semibold">Code sent</span>
                  </div>
                  {resendTimer > 0 && (
                    <p className="text-xs text-secondary">
                      Resend available in {Math.floor(resendTimer / 60)}:
                      {String(resendTimer % 60).padStart(2, "0")}
                    </p>
                  )}
                </div>
              ) : (
                <button
                  type="button"
                  onClick={handleResendOTP}
                  disabled={resendLoading || resendTimer > 0}
                  className="text-sm text-secondary hover:text-black transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                  {resendLoading ? (
                    "Sending..."
                  ) : (
                    <>
                      Didn't receive the code?{" "}
                      <span className="underline font-semibold">
                        Resend Code
                      </span>
                    </>
                  )}
                </button>
              )}
            </div>

            {/* Error Message */}
            {submitError && (
              <div className="p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg mb-5">
                <p className="text-sm">{submitError}</p>
              </div>
            )}

            {/* Next Button */}
            <div className="block-button">
              <form.Subscribe
                selector={(state) => [state.canSubmit, state.isSubmitting]}
                children={([canSubmit, isSubmitting]) => (
                  <button
                    type="submit"
                    disabled={!canSubmit || isSubmitting}
                    className="button-main w-full disabled:opacity-50 disabled:cursor-not-allowed">
                    {isSubmitting ? "Verifying..." : "Continue"}
                  </button>
                )}
              />
            </div>
          </form>
        </>
      )}

      {/* Stage 3: New Password */}
      {currentStage === 3 && (
        <>
          <div className="heading4">Set New Password</div>
          <div className="body1 mt-2">
            Enter your new password below
          </div>

          <form
            onSubmit={(e) => {
              e.preventDefault();
              e.stopPropagation();
              form.handleSubmit();
            }}
            className="md:mt-7 mt-4">
            <div className="space-y-5">
              {/* New Password */}
              <form.Field
                name="newPassword"
                children={(field) => {
                  const hasError =
                    field.state.meta.isTouched && !field.state.meta.isValid;

                  return (
                    <div>
                      <label
                        htmlFor="newPassword"
                        className="caption1 mb-2 block">
                        New Password <span className="text-red">*</span>
                      </label>
                      <input
                        className={`border-line px-4 py-3 w-full rounded-lg ${
                          hasError ? "border-red-600" : ""
                        }`}
                        id="newPassword"
                        name="newPassword"
                        type="password"
                        placeholder="New Password *"
                        autoComplete="new-password"
                        value={field.state.value}
                        onBlur={field.handleBlur}
                        onChange={(e) => field.handleChange(e.target.value)}
                      />
                      <PasswordStrengthIndicator
                        password={field.state.value}
                        minLength={8}
                      />
                      <FieldInfo field={field} />
                    </div>
                  );
                }}
              />

              {/* Confirm Password */}
              <form.Field
                name="confirmPassword"
                children={(field) => {
                  const hasError =
                    field.state.meta.isTouched && !field.state.meta.isValid;

                  return (
                    <div>
                      <label
                        htmlFor="confirmPassword"
                        className="caption1 mb-2 block">
                        Confirm Password <span className="text-red">*</span>
                      </label>
                      <input
                        className={`border-line px-4 py-3 w-full rounded-lg ${
                          hasError ? "border-red-600" : ""
                        }`}
                        id="confirmPassword"
                        name="confirmPassword"
                        type="password"
                        placeholder="Confirm Password *"
                        autoComplete="new-password"
                        value={field.state.value}
                        onBlur={field.handleBlur}
                        onChange={(e) => field.handleChange(e.target.value)}
                      />
                      <FieldInfo field={field} />
                    </div>
                  );
                }}
              />
            </div>

            {/* Error Message */}
            {submitError && (
              <div className="p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg mt-5">
                <p className="text-sm">{submitError}</p>
              </div>
            )}

            {/* Reset Password Button */}
            <div className="block-button mt-7">
              <form.Subscribe
                selector={(state) => [state.canSubmit, state.isSubmitting]}
                children={([canSubmit, isSubmitting]) => (
                  <button
                    type="submit"
                    disabled={!canSubmit || isSubmitting}
                    className="button-main w-full py-4 disabled:opacity-50 disabled:cursor-not-allowed">
                    {isSubmitting ? "Resetting Password..." : "Reset Password"}
                  </button>
                )}
              />
            </div>
          </form>
        </>
      )}
    </div>
  );
}
